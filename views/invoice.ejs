<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice</title>
</head>
<body>

    <h1 id="companyNameDisplay"><%= invoice.companyName %></h1>
    <input type="text" id="companyNameInput" value="<%= invoice.companyName %>" style="display:none;">

    <table id="itemsTable" style="border: 1px solid black; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="border: 1px solid black; width: 800px;">Item Name</th>
                <th style="border: 1px solid black; width: 300px;">Amount</th>
            </tr>
        </thead>
        <tbody>
        <% invoice.items.forEach(function(item, index) { %>
            <tr>
                <td style="border: 1px solid">
                    <span class="itemNameDisplay"><%= item.name %></span>
                    <input type="text" class="itemNameInput" value="<%= item.name %>" style="display:none;">
                </td>
                <td style="border: 1px solid">
                    <span class="itemAmountDisplay"><%= item.amount %>円</span>
                    <input type="number" class="itemAmountInput" value="<%= item.amount %>" style="display:none;">
                </td>
            </tr>
        <% }); %>
        </tbody>
    </table>
    
    <p id="totalAmount">Total: <%= invoice.totalAmount %>円</p>
    
    <button id="editButton">編集</button>
    <button id="addItemButton" style="display:none;">アイテム追加</button>
    <button id="saveButton" style="display:none;">保存</button>

    <script>
        document.getElementById('editButton').addEventListener('click', function() {
            document.getElementById('companyNameDisplay').style.display = 'none';
            document.getElementById('companyNameInput').style.display = '';
            document.querySelectorAll('.itemNameDisplay, .itemAmountDisplay').forEach(function(el) {
                el.style.display = 'none';
            });
            document.querySelectorAll('.itemNameInput, .itemAmountInput').forEach(function(input) {
                input.style.display = '';
            });
            this.style.display = 'none';
            document.getElementById('saveButton').style.display = '';
            document.getElementById('addItemButton').style.display = '';
            document.getElementById('invoiceForm').querySelector('button[type="submit"]').style.display = '';

        });

        document.getElementById('addItemButton').addEventListener('click', function() {
            // 表のtbodyを取得
            const tbody = document.querySelector('#itemsTable tbody');
            // 新しい行（tr要素）を作成
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td style="border: 1px solid">
                <input type="text" class="itemNameInput" value="" placeholder="アイテム名">
                </td>
                <td style="border: 1px solid">
                    <input type="number" class="itemAmountInput" value="" placeholder="金額">
                    </td>`;
                    // 作成した行をtbodyに追加
                    tbody.appendChild(tr);
                });

        document.getElementById('saveButton').addEventListener('click', function() {
            const companyName = document.getElementById('companyNameInput').value;
            // const items = Array.from(document.querySelectorAll('.itemNameInput')).map(function(input, index) {
            //     return {
            //         name: input.value,
            //         amount: parseFloat(document.querySelectorAll('.itemAmountInput')[index].value)
            //     };
            // });
            const items = Array.from(document.querySelectorAll('.itemNameInput')).map(function(itemInput, index) {
                const amountInput = document.querySelectorAll('.itemAmountInput')[index];
                return {
                    name: itemInput.value,
                    amount: parseFloat(amountInput.value)
                };
            });

            // Calculate the new total amount
            const newTotalAmount = items.reduce(function(total, item) {
                return total + item.amount;
            }, 0);

            console.log({ companyName, items, newTotalAmount });

            // Update UI
            document.getElementById('companyNameDisplay').innerText = companyName;
            document.getElementById('companyNameDisplay').style.display = '';
            document.getElementById('companyNameInput').style.display = 'none';
            updateItemsDisplay(items);
            document.querySelectorAll('.itemNameDisplay').forEach(function(el, index) {
                el.innerText = items[index].name;
                el.style.display = '';
            });
            document.querySelectorAll('.itemAmountDisplay').forEach(function(el, index) {
                el.innerText = items[index].amount + '円';
                el.style.display = '';
            });
            document.getElementById('totalAmount').innerText = 'Total: ' + newTotalAmount + '円';
            // document.querySelectorAll('.itemNameInput, .itemAmountInput').forEach(function(input) {
            //     input.style.display = 'none';
            // });
            document.querySelectorAll('.itemNameInput, .itemAmountInput').forEach(function(input) {
                input.style.display = 'none';
            });
            document.getElementById('editButton').style.display = '';
            this.style.display = 'none';
        });

        function updateItemsDisplay(items) {
            const itemsTableBody = document.querySelector('#itemsTable tbody');
            // 既存のアイテム表示をクリア
            itemsTableBody.innerHTML = '';
            // 新しいアイテムの表示を追加
            items.forEach(function(item) {
                const row = document.createElement('tr');
                const itemNameCell = document.createElement('td');
                itemNameCell.style.border = '1px solid black';
                itemNameCell.innerText = item.name;
                
                const itemAmountCell = document.createElement('td');
                itemAmountCell.style.border = '1px solid black';
                itemAmountCell.innerText = item.amount + '円';
                
                row.appendChild(itemNameCell);
                row.appendChild(itemAmountCell);
                itemsTableBody.appendChild(row);
            });
        }
    document.getElementById('saveButton').addEventListener('click', function() {
        const companyName = document.getElementById('companyNameInput').value;
        const items = Array.from(document.querySelectorAll('.itemNameInput')).map(function(itemInput, index) {
            const amountInput = document.querySelectorAll('.itemAmountInput')[index];
            return {
                name: itemInput.value,
                amount: parseFloat(amountInput.value)
            };
        });
        
        // Calculate the new total amount
        const newTotalAmount = items.reduce(function(total, item) {
            return total + item.amount;
        }, 0);
        
        // Set form values for companyName
        document.getElementById('formCompanyName').value = companyName;
    
        // Clear previous inputs and setup new inputs for items
        const itemsContainer = document.getElementById('formItemsContainer');
        itemsContainer.innerHTML = ''; // Clear previous inputs
        items.forEach(item => {
            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'items[][name]';
            nameInput.value = item.name;
            itemsContainer.appendChild(nameInput);

            const amountInput = document.createElement('input');
            amountInput.type = 'hidden';
            amountInput.name = 'items[][amount]';
            amountInput.value = item.amount;
            itemsContainer.appendChild(amountInput);
        });
        // Submit the form
        document.getElementById('invoiceForm').submit();
    });


    </script>
<form id="invoiceForm" action="/invoice/create" method="POST">
    <input type="hidden" name="companyName" id="formCompanyName">
    <div id="formItemsContainer"></div>
    <button type="submit" style="display:none;">請求書を保存</button>
</form>
</body>
</html>
